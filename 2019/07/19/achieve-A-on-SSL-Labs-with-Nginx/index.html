<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.3.0"><link rel="apple-touch-icon" sizes="180x180" href="https://blog-1253475808.file.myqcloud.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://blog-1253475808.file.myqcloud.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://blog-1253475808.file.myqcloud.com/favicon-16x16.png"><link rel="mask-icon" href="https://blog-1253475808.file.myqcloud.com/safari-pinned-tab.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Noto+Sans+SC:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="https://fontawesome-1253475808.file.myqcloud.com/css/all.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/animate.css/3.1.1/animate.min.css"><link rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css"><script src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js"></script><script class="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"burgertown.tk",root:"/",images:"/images",scheme:"Gemini",version:"8.2.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12},copycode:!1,bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!0,lazyload:!0,pangu:!0,comments:{style:"tabs",active:null,storage:!0,lazyload:!0,nav:null},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"fadeInDown",post_body:"fadeInDown",coll_header:"fadeInLeft",sidebar:"fadeInUp"}},prism:!1,i18n:{placeholder:"搜索...",empty:"没有找到任何搜索结果：${query}",hits_time:"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）",hits:"找到 ${hits} 个搜索结果"}}</script><meta name="description" content="跟上时代的步伐 Part.3"><meta property="og:type" content="article"><meta property="og:title" content="在 SSL Lab 中达到 A+评分的 Nginx 配置"><meta property="og:url" content="https://burgertown.tk/2019/07/19/achieve-A-on-SSL-Labs-with-Nginx/index.html"><meta property="og:site_name" content="BurgerBlog"><meta property="og:description" content="跟上时代的步伐 Part.3"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://blog-1253475808.file.myqcloud.com/picBed/ZjbGYn.webp"><meta property="article:published_time" content="2019-07-19T01:28:03.000Z"><meta property="article:modified_time" content="2021-02-03T12:21:39.807Z"><meta property="article:author" content="BurgerTown"><meta property="article:tag" content="Web"><meta property="article:tag" content="Nginx"><meta property="article:tag" content="Https"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://blog-1253475808.file.myqcloud.com/picBed/ZjbGYn.webp"><link rel="canonical" href="https://burgertown.tk/2019/07/19/achieve-A-on-SSL-Labs-with-Nginx/"><script data-pjax class="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>在 SSL Lab 中达到 A+评分的 Nginx 配置 | BurgerBlog</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-117112515-2"></script><script data-pjax>if(CONFIG.hostname===location.hostname){function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-117112515-2")}</script><script data-pjax defer="defer" src="https://static.cloudflareinsights.com/beacon.min.js" data-cf-beacon='{"token": "e1d8770e8a8e4b21a4dcf02f5900c843"}'></script><noscript><style>body{margin-top:2rem}.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header,.use-motion .sidebar{visibility:visible}.use-motion .footer,.use-motion .header,.use-motion .site-brand-container .toggle{opacity:initial}.use-motion .custom-logo-image,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line{transform:scaleX(1)}.search-pop-overlay,.sidebar-nav{display:none}.sidebar-panel{display:block}</style></noscript><link rel="alternate" href="/atom.xml" title="BurgerBlog" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage" class="use-motion"><div class="headband"></div><main class="main"><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><i class="logo-line"></i><h1 class="site-title">BurgerBlog</h1><i class="logo-line"></i></a> <img class="custom-logo-image" src="https://blog-1253475808.file.myqcloud.com/favicon.png" alt="BurgerBlog"></div><div class="site-nav-right"><div class="toggle popup-trigger"></div></div></div><nav class="site-nav"><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">22</span></a></li><li class="menu-item menu-item-updatelogs"><a href="/updatelogs/" rel="section"><i class="fas fa-clipboard-check fa-fw"></i>日志</a></li></ul></nav></div><div class="toggle sidebar-toggle" role="button"><span class="toggle-line"></span><span class="toggle-line"></span><span class="toggle-line"></span></div><aside class="sidebar"><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class="sidebar-nav"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="sidebar-panel-container"><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E6%83%85"><span class="nav-text">前情</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Certificate"><span class="nav-text">Certificate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Protocol-Support"><span class="nav-text">Protocol Support</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%85%E5%90%AF%E7%94%A8-TLS-v1-2"><span class="nav-text">仅启用 TLS v1.2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8C%E6%97%B6%E5%90%AF%E7%94%A8-TLSv1-1-%E5%92%8C-TLS-v1-2"><span class="nav-text">同时启用 TLSv1.1 和 TLS v1.2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8C%E6%97%B6%E5%90%AF%E7%94%A8-TLS-v1-0-TLSv1-1-%E5%92%8C-TLS-v1-2"><span class="nav-text">同时启用 TLS v1.0 TLSv1.1 和 TLS v1.2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%91%E7%9A%84%E5%BB%BA%E8%AE%AE"><span class="nav-text">我的建议</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Key-Exchange"><span class="nav-text">Key Exchange</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Cipher-Strength"><span class="nav-text">Cipher Strength</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HTTP-Strict-Transport-Security"><span class="nav-text">HTTP Strict Transport Security</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Improve-Performance"><span class="nav-text">Improve Performance</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#OCSP-Stapling"><span class="nav-text">OCSP Stapling</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SSL-Session-Caching-Session-Resumption"><span class="nav-text">SSL Session Caching (Session Resumption)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%90%8E%E8%AE%B0-amp-%E7%9B%B8%E5%85%B3%E9%93%BE%E6%8E%A5"><span class="nav-text">后记&amp;相关链接</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E9%93%BE%E6%8E%A5"><span class="nav-text">相关链接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E7%94%A8%E9%85%8D%E7%BD%AE"><span class="nav-text">自用配置</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="BurgerTown" src="https://blog-1253475808.file.myqcloud.com/favicon.png"><p class="site-author-name" itemprop="name">BurgerTown</p><div class="site-description" itemprop="description">Not too bad,hmm?</div></div><div class="site-state-wrap site-overview-item animated"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">22</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">2</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">14</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author site-overview-item animated"><span class="links-of-author-item"><a href="https://github.com/BurgerTown" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;BurgerTown" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://t.me/BurgerTown_Lord" title="Telegram → https:&#x2F;&#x2F;t.me&#x2F;BurgerTown_Lord" rel="noopener" target="_blank"><i class="fab fa-telegram fa-fw"></i> Telegram</a></span><span class="links-of-author-item"><a href="https://blog-1253475808.file.myqcloud.com/atom.xml" title="RSS → https:&#x2F;&#x2F;blog-1253475808.file.myqcloud.com&#x2F;atom.xml" rel="noopener" target="_blank"><i class="fas fa-rss fa-fw"></i> RSS</a></span></div></div></div></div></aside><div class="sidebar-dimmer"></div></header><div class="back-to-top" role="button"><i class="fa fa-arrow-up"></i> <span>0%</span></div><noscript><div class="noscript-warning">Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class="post-block"><article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN"><link itemprop="mainEntityOfPage" href="https://burgertown.tk/2019/07/19/achieve-A-on-SSL-Labs-with-Nginx/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://blog-1253475808.file.myqcloud.com/favicon.png"><meta itemprop="name" content="BurgerTown"><meta itemprop="description" content="Not too bad,hmm?"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="BurgerBlog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 在 SSL Lab 中达到 A+评分的 Nginx 配置</h1><div class="post-meta-container"><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-07-19 09:28:03" itemprop="dateCreated datePublished" datetime="2019-07-19T09:28:03+08:00">2019-07-19</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar-check"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2021-02-03 20:21:39" itemprop="dateModified" datetime="2021-02-03T20:21:39+08:00">2021-02-03</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Tech/" itemprop="url" rel="index"><span itemprop="name">Tech</span></a></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Waline：</span><a title="waline" href="/2019/07/19/achieve-A-on-SSL-Labs-with-Nginx/#waline-comments" itemprop="discussionUrl"><span class="post-comments-count waline-comment-count" id="/2019/07/19/achieve-A-on-SSL-Labs-with-Nginx/" data-xid="/2019/07/19/achieve-A-on-SSL-Labs-with-Nginx/" itemprop="commentCount"></span></a></span><span id="/2019/07/19/achieve-A-on-SSL-Labs-with-Nginx/" class="post-meta-item leancloud_visitors" data-flag-title="在 SSL Lab 中达到 A+评分的 Nginx 配置" title="阅读次数"><span class="post-meta-item-icon"><i class="far fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span class="leancloud-visitors-count"></span></span></div><div class="post-description">跟上时代的步伐 Part.3</div></div></header><div class="post-body" itemprop="articleBody"><h2 id="前情"><a href="#前情" class="headerlink" title="前情"></a>前情</h2><p>曾经在 <a href="/2017/07/11/Https-Nginx-Hexo-Git/">这里</a> 讲述了如何用 acme.sh 申请 RSA 证书并开启 Https</p><p>本文参考了 <a target="_blank" rel="noopener" href="https://medium.com/@aditya.vssut/setting-up-nginx-configuration-to-get-an-a-in-ssl-labs-server-test-e0e25098d634">How to get an ‘A+’ in SSL Labs Server Test with NginX configuration</a> 所以也可以认为是一个大致的汉化</p><p><strong>但是原文发布于 2018/10/8 某些地方可能已经过时</strong></p><p><img data-src="https://blog-1253475808.file.myqcloud.com/picBed/ZjbGYn.webp" alt="ZjbGYn.webp"></p><p>可以看到 SSL Lab 的评判有四方面 这里一个个说</p><h2 id="Certificate"><a href="#Certificate" class="headerlink" title="Certificate"></a>Certificate</h2><blockquote><p>This section is fairly easy to get 100% on. Use a well known or trusted CA(Certificate Authority) and make sure your certificate and chain are in the correct order. The most important certificate configuration setting is the fingerprint hashing algorithm. Ensure that you have created a SHA256-signed certificate and not SHA1. Until recently, most certificates were signed using SHA1. However, its becoming dangerously insecure as computing power advances. In its place, new certificates should be signed using SHA256.</p></blockquote><p>简单来说就是只需要有一个受信任的 CA 签发、加密算法不是 SHA1 的证书即可</p><p>所以这里只需要使用 acme.sh 生成证书就可以达到 100%</p><h2 id="Protocol-Support"><a href="#Protocol-Support" class="headerlink" title="Protocol Support"></a>Protocol Support</h2><blockquote><p>Disable SSLv3<br>By default Nginx still enables SSLv3, which has been vulnerable to the POODLE attack since October 2014. SSL Labs rightly limits your server’s SSL score to C if SSLv3 is enabled, so this is the first thing to change.<br>Using only TLSv1.2<br>If you want to score 100% in this section, you will have to use only TLSv1.2 as your supported SSL protocols. However, most of the older clients will not able to load your site.<br>Using TLSv1.1&amp;v1.2<br>Using TLSv1.1 &amp; v1.2 will get you a score of 95% in this section, but some of the older clients will still not be able to load your site.<br>Use TLS1.0~1.2<br>Although using this suite will give you a score of 90%, this would be the best compatible option suggested by me, and you will still be able to score an overall ‘A+’. Don’t use protocols older than TLS1.0 since it’s been deprecated.</p></blockquote><p>这里原作者给出了几个解决方案</p><p>但是首先 禁用 SSLv3</p><p>默认情况下 Nginx 还是会启用 SSLv3 但是此协议被 <a target="_blank" rel="noopener" href="https://www.us-cert.gov/ncas/alerts/TA14-290A">证实是有漏洞</a> 的</p><h3 id="仅启用-TLS-v1-2"><a href="#仅启用-TLS-v1-2" class="headerlink" title="仅启用 TLS v1.2"></a>仅启用 TLS v1.2</h3><p>这样可以达到 100% 但是某些老的客户端会有兼容性问题</p><h3 id="同时启用-TLSv1-1-和-TLS-v1-2"><a href="#同时启用-TLSv1-1-和-TLS-v1-2" class="headerlink" title="同时启用 TLSv1.1 和 TLS v1.2"></a>同时启用 TLSv1.1 和 TLS v1.2</h3><p>达到 95% 同时保持某些老客户端的兼容</p><h3 id="同时启用-TLS-v1-0-TLSv1-1-和-TLS-v1-2"><a href="#同时启用-TLS-v1-0-TLSv1-1-和-TLS-v1-2" class="headerlink" title="同时启用 TLS v1.0 TLSv1.1 和 TLS v1.2"></a>同时启用 TLS v1.0 TLSv1.1 和 TLS v1.2</h3><p>这样会有 90% 同时保持最大的兼容性</p><h3 id="我的建议"><a href="#我的建议" class="headerlink" title="我的建议"></a>我的建议</h3><p>但其实 TLS v1.0 和 TLSv1.1 现已被 SSL Lab 打上了黄色 所以我建议<em>同时启用 TLS v1.2 和 TLS v1.3</em></p><p>如何开启 TLS v1.3? <a href="/2019/07/18/compile-Nginx-on-CentOS-7-to-enable-TLS1-3/">在 CentOS 7 上编译 Nginx 使其启用 TLS v1.3</a></p><p>Nginx 配置如下</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssl_protocols TLSv1.2 TLSv1.3;</span><br></pre></td></tr></table></figure><h2 id="Key-Exchange"><a href="#Key-Exchange" class="headerlink" title="Key Exchange"></a>Key Exchange</h2><blockquote><p>To increase the Key Exchange score, we need to increase the size of the key used in the DH exchange. Nginx uses OpenSSL’s default 1024 bit key size as an input to the DH key exchange, resulting in a 1024 bit key. Ideally, we should be using a key number smaller than our SSL certificate which is commonly 2048 or even 4096 bits.</p></blockquote><p>要提高<code>Key Exchange</code>的分数 就要提高用于 DH 交换的密钥的位数 Nginx 默认使用 1024 位的密钥来作 DH 交换</p><p>所以要提高分数 就需要将其提升至 2048 位甚至是 4096 位</p><p>执行以下代码来生成</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl dhparam -out /etc/nginx/dhparam.pem 4096</span><br></pre></td></tr></table></figure><p>生成过程可能会长达几分钟 所以你想的话也可以降低位数到 2048 然后需要配置 Nginx</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssl_dhparam /etc/nginx/dhparam.pem;</span><br></pre></td></tr></table></figure><h2 id="Cipher-Strength"><a href="#Cipher-Strength" class="headerlink" title="Cipher Strength"></a>Cipher Strength</h2><p>这里原文写了一大堆算法 对于想了解的可以直接去看原文</p><p>我这里只给出 Nginx 配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssl_prefer_server_ciphers on;</span><br><span class="line">ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE+3DES:RSA+3DES;</span><br></pre></td></tr></table></figure><h2 id="HTTP-Strict-Transport-Security"><a href="#HTTP-Strict-Transport-Security" class="headerlink" title="HTTP Strict Transport Security"></a>HTTP Strict Transport Security</h2><p>经过以上操作 你会在 SSL Lab 里达到 A 的评级了 想要更进一步 就需要开启 HSTS</p><blockquote><p>By enabling HSTS, the browsers will not allow users to attempt any connection using HTTP and always enforce the use of HTTPS. This means that, after a first visit from a client to the server, subsequent visits to any HTTP pages will be converted by the browser to HTTPS before any request is made. This saves us some round trip time and increases security, especially against many SSL stripping attacks. HSTS also prevents the constant need for you to redirect clients from HTTP to HTTPS and many other configuration errors that are easy to make.</p></blockquote><p>简单来说 加入了这个 Header 访问了一次该域名 以后浏览器就会强制对此域名的所有连接都进行 HTTPS 访问</p><p>在 Nginx 配置里加入</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add_header Strict-Transport-Security &quot;max-age=31536000; includeSubDomains; preload&quot; always;</span><br></pre></td></tr></table></figure><blockquote><p>max-age=31536000<br>The 31536000 seconds are roughly around a year. So, the browser will remember for a year that it should always visit your website through HTTPS. If, for any reason, you want to stop supporting HTTPS for your website, you will have a problem with browsers that have already received this header. Would you redirect any HTTPS traffic back to HTTP, such browsers would redirect again to HTTPS resulting in an infinite loop. Therefore, if you are just playing around with SSL and aren’t sure you will keep it for your website, don’t enable HSTS for that website.</p></blockquote><p>31536000 秒即大概一年的时间 浏览器会记住这么长时间</p><blockquote><p>includeSubDomains<br>The includeSubDomains clause tells the browser to also enable HSTS for sub-domains. So remove this, if not all your sub-domains are ready for HTTPS.</p></blockquote><p>看英文都很好理解啦 包括所有子域名</p><blockquote><p>preload<br>With the first HTTP request, a browser is still potentially vulnerable. Using “preload” clause, we tell browsers not to make even one HTTP request to the server. This is done by submitting your website to the HSTS preload list. By submitting your website to the HSTS preload list, you tell browsers to never visit your website through HTTP. Addition to the preload list will have semi-permanent consequence and is irreversible, so only use this option once you’re comfortably set up running HTTPS with no problems.</p></blockquote><p>对于初次的连接 浏览器还是会使用 HTTP 加入这个参数并且提交你的域名至 <a target="_blank" rel="noopener" href="https://hstspreload.org/">HSTS preload list</a> 即可</p><p><strong>注意：HSTS preload list 是不可逆转且半永久的 所以提前之前请慎重考虑</strong></p><blockquote><p>always<br>The “always” after the header contents tell NginX to provide this header with every possible response code, instead of only for the “200, 201, 204, 206, 301, 302, 303, 304, or 307” status codes.</p></blockquote><p>即把此头部应用在所有的响应内容中 不止 200 201 204 等</p><h2 id="Improve-Performance"><a href="#Improve-Performance" class="headerlink" title="Improve Performance"></a>Improve Performance</h2><blockquote><p>Even though we already achieved the A+ rating, there is some more we can still improve. These changes won’t affect your scoring but are necessary to improve performance.</p></blockquote><p>这时 SSL Lab 里已经能评上 A+了 但还有些能提升性能但不降分的操作能做</p><h3 id="OCSP-Stapling"><a href="#OCSP-Stapling" class="headerlink" title="OCSP Stapling"></a>OCSP Stapling</h3><blockquote><p>With each certificate a browser receives, it performs a request to a Certificate Authority to check whether the certificate has expired. This causes extra waiting time and it decreases security. Instead of the browser checking the status of the provided certificate, the server can be made to check this on a regular interval using the Online Certificate Status Protocol (OCSP). The OCSP responses are signed by your Certification Authority, so browsers will be able to trust them, even if they come directly from your server.</p></blockquote><p>简单来说 OCSP 用于检测证书是否过期 但这就造成了额外的等待时间</p><p>OCSP Stapling 则解决了上述的问题 服务端主动通过 OCSP 获得证书状态 并随着证书一起发送给客户端 这样客户端就可以跳过自己去验证的步骤 以提高 SSL 握手的效率</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ssl_stapling             on;</span><br><span class="line">ssl_stapling_verify      on;</span><br><span class="line">resolver                 119.29.29.29 114.114.114.114 valid=300s;</span><br><span class="line">resolver_timeout         10s;</span><br></pre></td></tr></table></figure><h3 id="SSL-Session-Caching-Session-Resumption"><a href="#SSL-Session-Caching-Session-Resumption" class="headerlink" title="SSL Session Caching (Session Resumption)"></a>SSL Session Caching (Session Resumption)</h3><blockquote><p>To minimise the impact of the SSL overheads on your server, you can reduce the number of handshakes that a client needs to perform. The handshake is the most expensive part of serving content over SSL. With session resumption, the server specifies some information to the client during the initial TLS handshake. In a second connection, the client can then use this information to skip the entire TLS handshake and immediately have a secure connection setup. We can enable the SSL cache to remove the need for a handshake on subsequent or parallel connections.</p></blockquote><p>简而言之 SSL Session 也要缓存 这样就会减少握手次数 从而提升性能</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssl_session_cache shared:SSL:10m;</span><br><span class="line">ssl_session_timeout 10m;</span><br></pre></td></tr></table></figure><h2 id="后记-amp-相关链接"><a href="#后记-amp-相关链接" class="headerlink" title="后记&amp;相关链接"></a>后记&amp;相关链接</h2><h3 id="相关链接"><a href="#相关链接" class="headerlink" title="相关链接"></a>相关链接</h3><p><a target="_blank" rel="noopener" href="https://medium.com/@aditya.vssut/setting-up-nginx-configuration-to-get-an-a-in-ssl-labs-server-test-e0e25098d634">How to get an ‘A+’ in SSL Labs Server Test with NginX configuration</a></p><p><a target="_blank" rel="noopener" href="https://gist.github.com/fotock/9cf9afc2fd0f813828992ebc4fdaad6f">Nginx SSL 安全配置最佳实践</a></p><p>看完上面两个会更容易理解我给出的配置</p><h3 id="自用配置"><a href="#自用配置" class="headerlink" title="自用配置"></a>自用配置</h3><p>分享我自用的一套通用配置</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 443  http2 fastopen=3 reuseport ssl default;</span><br><span class="line">    server_tokens off;</span><br><span class="line">    server_name  *.burgertown.tk;</span><br><span class="line"></span><br><span class="line">    ssl_certificate &quot;/path/to/rsa/fc&quot;;</span><br><span class="line">    ssl_certificate_key &quot;/path/to/rsa/key&quot;;</span><br><span class="line"></span><br><span class="line">    ssl_certificate &quot;/path/to/ecc/fc&quot;;</span><br><span class="line">    ssl_certificate_key &quot;/path/to/ecc/key&quot;;</span><br><span class="line"></span><br><span class="line">    ssl_dhparam &quot;/root/ssl/dhparam&quot;;</span><br><span class="line">    ssl_session_cache        shared:SSL:10m;</span><br><span class="line">    ssl_session_tickets      on;</span><br><span class="line">    ssl_stapling             on;</span><br><span class="line">    ssl_stapling_verify      on;</span><br><span class="line">    resolver                 119.29.29.29 114.114.114.114 valid=300s;</span><br><span class="line">    resolver_timeout         10s;</span><br><span class="line">    ssl_protocols TLSv1.2 TLSv1.3;</span><br><span class="line">    ssl_prefer_server_ciphers on;</span><br><span class="line">    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE+3DES:RSA+3DES;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">add_header X-Frame-Options DENY;</span><br><span class="line">add_header Referrer-Policy &quot;no-referrer&quot;;</span><br><span class="line">add_header X-XSS-Protection &quot;1; mode=block&quot;;</span><br><span class="line">add_header X-Content-Type-Options nosniff;</span><br><span class="line">add_header Access-Control-Allow-Origin *;</span><br><span class="line">add_header Strict-Transport-Security &quot;max-age=63072000; includeSubdomains; preload&quot; always;</span><br><span class="line">add_header Content-Security-Policy &quot;upgrade-insecure-requests&quot;;</span><br><span class="line">add_header Cache-Control &quot;max-age=36000&quot;;</span><br></pre></td></tr></table></figure></div><footer class="post-footer"><div class="reward-container"><div>请我喝杯咖啡~</div> <button onclick='document.querySelector(".post-reward").classList.toggle("active")'> 赞赏</button><div class="post-reward"><div> <img src="https://blog-1253475808.file.myqcloud.com/wechatpay.png" alt="BurgerTown 微信"> <span>微信</span></div><div> <img src="https://blog-1253475808.file.myqcloud.com/alipay.png" alt="BurgerTown 支付宝"> <span>支付宝</span></div></div></div><div class="post-tags"><a href="/tags/Web/" rel="tag"><i class="fa fa-tag"></i> Web</a><a href="/tags/Nginx/" rel="tag"><i class="fa fa-tag"></i> Nginx</a><a href="/tags/Https/" rel="tag"><i class="fa fa-tag"></i> Https</a></div><div class="post-nav"><div class="post-nav-item"><a href="/2019/07/19/acme-sh-issue-ecc-cert-and-set-up-dual-cert/" rel="prev" title="使用 acme.sh 申请 ECC 证书并设置 Nginx 使其使用双证书"><i class="fa fa-chevron-left"></i> 使用 acme.sh 申请 ECC 证书并设置 Nginx 使其使用双证书</a></div><div class="post-nav-item"> <a href="/2019/07/20/use-cdn-to-accelerate-blog/" rel="next" title="使用 CDN 加速博客的访问速度">使用 CDN 加速博客的访问速度<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="waline-comments"></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; <span itemprop="copyrightYear">2021</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">BurgerTown</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动</div></div></footer><script src="https://blog-1253475808.file.myqcloud.com/custom_js/anime.min.js"></script><script src="https://blog-1253475808.file.myqcloud.com/custom_js/pjax.min.js"></script><script src="https://blog-1253475808.file.myqcloud.com/custom_js/medium-zoom.min.js"></script><script src="https://blog-1253475808.file.myqcloud.com/custom_js/lozad.min.js"></script><script src="https://lib.baomitu.com/pangu/4.0.7/pangu.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script><script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '.page-configurations',
    '.main-inner',
    '.post-toc-wrap',
    '.languages',
    '.pjax'
  ],
  analytics: false,
  cacheBust: false,
  scrollRestoration: false,
  scrollTo: !CONFIG.bookmark.enable
});

document.addEventListener('pjax:success', () => {
  pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  const hasTOC = document.querySelector('.post-toc');
  document.querySelector('.sidebar-inner').classList.toggle('sidebar-nav-active', hasTOC);
  document.querySelector(hasTOC ? '.sidebar-nav-toc' : '.sidebar-nav-overview').click();
  NexT.utils.updateSidebarPosition();
});
</script><script>
    NProgress.configure({
      showSpinner: true
    });
    NProgress.start();
    document.addEventListener('readystatechange', () => {
      if (document.readyState === 'interactive') {
        NProgress.inc(0.8);
      }
      if (document.readyState === 'complete') {
        NProgress.done();
      }
    });
    document.addEventListener('pjax:send', () => {
      NProgress.start();
    });
    document.addEventListener('pjax:success', () => {
      NProgress.done();
    });
  </script><div class="pjax"><script>
NexT.utils.loadComments('#waline-comments', () => {
  NexT.utils.getScript('https://blog-1253475808.file.myqcloud.com/custom_js/Waline.min.js', () => {
    new Waline(Object.assign({
      lang: 'zh-CN'
    }, {"enable":true,"serverURL":"https://waline.burgertown.tk","placeholder":"Just go go","avatar":"retro","meta":["nick","mail","link"],"pageSize":10,"visitor":true,"comment_count":true,"requiredFields":["nick","mail"],"lang":"zh-cn","libUrl":"https://blog-1253475808.file.myqcloud.com/custom_js/Waline.min.js"}, {
      el: '#waline-comments',
      path: "/2019/07/19/achieve-A-on-SSL-Labs-with-Nginx/",
    }));
  }, window.Waline);
});
</script></div></body></html>